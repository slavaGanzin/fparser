#!/usr/bin/env node
require('../lib/listeners')
require('../lib/global')
parser = require('../lib/parser')
          
parseRange = compose(map(Number), split('..'))
increaseVerbosity = (_, total) => ++total

global.finishHandlers = []

parsePlaceholders = compose(
  fromPairs,
  map(adjust(x => '$'+x, 0)),
  map(split('=')),
  dropLast(1)
)

prepareOutput = x => JSON[ARGV.nopretty?'stringify':'pretty'](x)
output = compose(console.log, prepareOutput, flatten)

runFinishHandlers = () => map(call, global.finishHandlers)

ARGV
  .version(require('../package.json').version)
  .option('-S, --no-skip'           , 'Do not skip on parse')
  .option('-s, --no-save'           , 'Do not save results')
  .option('-f, --forward [action]'  , 'Forward result to --forward [action] or skip forwarding with -f')
  .option('-r, --range <from>..<to>', 'Process only <from>..<to> records', parseRange)
  .option('-v, --verbose'           , 'Verbosity level', increaseVerbosity, 0)
  .option('-P, --nopretty'          , 'Disable formatting of output')
  // .option('-d, --debug'             , 'Display debug info')
  .option('-l, --placeholders'      , 'List placeholders')
  
  .usage('<parsername> [placeholders...]')
  .action((name, ...placeholders) =>
    parser.parse({name, placeholders: parsePlaceholders(placeholders)})
      .then(output)
      .then(runFinishHandlers)
  )
  .parse(process.argv)
